# TIL — Chapter 17 (상품 등록 완료 및 회원가입 지도 개선)

## 개요
Part 1: 상품 등록 완료 및 LocalMockProductRepository 저장
Part 2: 회원가입 지역 선택 페이지에 Flutter Map 통합

---

## Part 1: 상품 등록 완료

### 1. submit() 메서드 구현

**ProductWriteController:**
```dart
Future<bool> submit() async {
  // 유효성 검사
  if (!_isFormValid()) {
    return false;
  }
  
  isLoading(true);
  
  try {
    // 가격 계산
    final int price = isFree.value ? 0 : (int.tryParse(priceText.value) ?? 0);
    
    // ProductModel 생성
    final product = ProductModel(
      title: title.value.trim(),
      description: description.value.trim(),
      price: price,
      isFree: isFree.value,
      isPriceSuggest: isPriceSuggest.value,
      locationLabel: locationLabel.value,
      latitude: selectedLocation.value.latitude,
      longitude: selectedLocation.value.longitude,
      thumbnailUrl: imageUrls.isNotEmpty ? imageUrls.first : null,
      imageUrls: imageUrls.toList(),
      category: selectedCategory.value,
      condition: selectedCondition.value,
      sellerName: '나(현재 사용자)',
      sellerId: 'current_user_123',
      viewCount: 0,
      likers: [],
    );
    
    // 저장소에 추가
    await _repository.addProduct(product);
    
    // HomeController 초기화 (중요!)
    if (Get.isRegistered<HomeController>()) {
      final homeController = Get.find<HomeController>();
      homeController.loadInitial();
    }
    
    // 홈으로 이동
    Get.offAllNamed('/home');
    
    return true;
  } catch (e) {
    return false;
  } finally {
    isLoading(false);
  }
}
```

### 2. LocalMockProductRepository.addProduct()

```dart
Future<void> addProduct(ProductModel product) async {
  await Future.delayed(const Duration(milliseconds: 300));
  _products.insert(0, product);  // 맨 앞에 삽입 (최신순)
}
```

**특징:**
- 새 상품을 목록 맨 앞(index 0)에 추가
- 홈 화면에서 최신 상품이 가장 위에 표시

### 3. 상품 등록 흐름

```
완료 버튼 클릭
  ↓
1. _isFormValid() 검사
  ↓
2. isLoading(true)
  ↓
3. ProductModel 생성
  - 모든 입력 데이터 포함
  - 첫 번째 이미지를 썸네일로 설정
  ↓
4. repository.addProduct(product)
  - 목업 저장소에 상품 추가
  ↓
5. HomeController.loadInitial()
  - 홈 화면 데이터 새로고침
  ↓
6. Get.offAllNamed('/home')
  - 홈 화면으로 이동 (뒤로 가기 불가)
  ↓
7. isLoading(false)
```

---

## Part 2: 회원가입 지역 선택 Flutter Map

### 4. 기존(Before) vs 개선(After)

**Before (정적 이미지):**
```dart
Image.network(
  'https://tile.openstreetmap.org/13/6546/3226.png',
  fit: BoxFit.cover,
)
```
- ❌ 제주도 전체를 제대로 표현 못함
- ❌ 확대/축소/이동 불가

**After (Flutter Map):**
- ✅ 제주도 전체 표시
- ✅ 4개 지역 마커로 위치 표시
- ✅ 확대/축소/이동 가능
- ✅ 선택된 지역 하이라이트

### 5. 지역 좌표 정의

```dart
static final Map<String, LatLng> regionCoordinates = {
  '아라동': const LatLng(33.4734, 126.4836),
  '연동': const LatLng(33.4890, 126.4783),
  '노형동': const LatLng(33.4785, 126.4518),
  '삼도동': const LatLng(33.5102, 126.5219),
};

static const LatLng jejuCenter = LatLng(33.4996, 126.5312);
```

### 6. Flutter Map 구현

**동적 중심 및 줌:**
```dart
Obx(() {
  final selectedRegion = controller.region.value;
  final center = selectedRegion.isNotEmpty
      ? regionCoordinates[selectedRegion]!
      : jejuCenter;
  
  return FlutterMap(
    options: MapOptions(
      initialCenter: center,
      initialZoom: selectedRegion.isNotEmpty ? 14 : 12,
      interactionOptions: const InteractionOptions(
        flags: InteractiveFlag.pinchZoom | InteractiveFlag.drag,
      ),
    ),
    children: [
      TileLayer(
        urlTemplate: 'https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png',
        subdomains: const ['a', 'b', 'c'],
      ),
      MarkerLayer(markers: [...]),
    ],
  );
})
```

**중심 및 줌 동작:**
- 지역 선택 전: 제주도 중심 (줌 12)
- 지역 선택 후: 해당 지역 중심 (줌 14)

### 7. 마커 시스템

**4개 지역 모두에 마커 표시:**
```dart
MarkerLayer(
  markers: regions.map((region) {
    final isSelected = selectedRegion == region;
    final coordinate = regionCoordinates[region]!;
    
    return Marker(
      point: coordinate,
      width: isSelected ? 50 : 40,
      height: isSelected ? 50 : 40,
      child: Column(
        children: [
          Container(
            width: isSelected ? 40 : 30,
            height: isSelected ? 40 : 30,
            decoration: BoxDecoration(
              color: isSelected
                  ? const Color(0xffED7738)
                  : Colors.grey.withOpacity(0.7),
              borderRadius: BorderRadius.circular(isSelected ? 20 : 15),
              border: Border.all(color: Colors.white, width: isSelected ? 3 : 2),
            ),
            child: Icon(Icons.location_on, color: Colors.white),
          ),
          // 선택된 지역에만 라벨 표시
          if (isSelected)
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
              decoration: BoxDecoration(
                color: const Color(0xffED7738),
                borderRadius: BorderRadius.circular(4),
              ),
              child: AppFont(region, size: 10, color: Colors.white),
            ),
        ],
      ),
    );
  }).toList(),
)
```

**마커 시각적 구분:**

| 상태 | 크기 | 색상 | 라벨 |
|------|------|------|------|
| 선택됨 | 40x40px | 주황색 | 표시 |
| 선택 안 됨 | 30x30px | 회색 | 숨김 |

### 8. 동작 흐름

```
초기: 지역 선택 안 됨
  ↓
지도: 제주도 중심 (줌 12)
마커: 4개 모두 회색
  ↓
사용자: '연동' 버튼 클릭
  ↓
controller.setRegion('연동')
  ↓
Obx() 재빌드
  ↓
지도: 연동으로 이동 (줌 14)
마커: 연동은 주황색 + 라벨, 나머지는 회색
  ↓
사용자: 지도 확대/축소/이동 가능
  ↓
"위치 저장하고 회원가입" 버튼 클릭
  ↓
controller.signup()
  ↓
홈 화면으로 이동
```

### 9. 상품 등록과 회원가입의 일관성

두 곳 모두 동일한 Flutter Map 사용:
- ✅ 같은 제주도 좌표 시스템
- ✅ 같은 OpenStreetMap 타일  
- ✅ 일관된 사용자 경험
- ✅ 코드 재사용성

---

## 10. Firebase 미사용

**GitHub 공식 코드:**
- Firebase Storage로 이미지 업로드
- Cloud Firestore에 상품 저장
- CupertinoAlertDialog 완료 메시지

**현재 프로젝트:**
- 로컬 파일 경로 사용
- LocalMockProductRepository 사용
- Get.offAllNamed()로 즉시 홈 이동
- 간소화된 학습용 구현

---

## 11. 구현 완료 체크리스트

✅ ProductWriteController.submit() 구현
✅ ProductModel 생성 로직
✅ LocalMockProductRepository.addProduct()
✅ HomeController.loadInitial() 호출
✅ Get.offAllNamed('/home')로 홈 이동
✅ RegionSelectPage에 Flutter Map 통합
✅ 지역별 좌표 정의
✅ 4개 지역 마커 표시
✅ 선택된 지역 하이라이트 (색상, 크기, 라벨)
✅ 동적 중심 및 줌 레벨

---

## 12. 핵심 학습점

- **상품 등록:** ProductModel 생성 및 저장소 추가
- **Controller 통신:** `Get.find<HomeController>()`로 다른 Controller 접근
- **리스트 업데이트:** `insert(0, product)`로 맨 앞에 추가
- **Flutter Map 고급:** 동적 중심, 줌, 마커 시스템
- **Obx() 활용:** 상태 변화에 따른 지도 재렌더링
- **시각적 피드백:** 선택된 항목 하이라이트
- **사용자 경험:** 즉각적인 피드백 (홈 화면 자동 갱신)
