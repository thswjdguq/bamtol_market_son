# TIL — Chapter 15 (상품 등록 페이지 기본 구성)

## 개요
상품 등록 폼의 기본 UI와 상태 관리를 구현하는 챕터.
이미지 선택, 텍스트 입력, Flutter Map 통합, 드롭다운, 체크박스 모두 포함.

## 1. 패키지 추가

**pubspec.yaml:**
```yaml
dependencies:
  image_picker: ^1.2.1    # 이미지 선택
  flutter_map: ^8.2.2     # 지도 표시
  latlong2: ^0.9.1        # 좌표 처리
```

## 2. ProductWriteController 생성

**주요 상태 변수:**
- `RxList<String> imageUrls` — 선택된 이미지 파일 경로  
- `RxString title` — 상품 제목
- `RxString description` — 상품 설명
- `RxString priceText` — 가격 (문자열)
- `RxBool isFree` — 무료 나눔 여부
- `RxBool isPriceSuggest` — 가격 제안 받기
- `RxString selectedCategory` — 카테고리 (전자기기, 의류 등)
- `RxString selectedCondition` — 상태 (새 상품, 사용감 있음 등)
- `RxString locationLabel` — 지역명 (아라동, 연동 등)
- `Rx<LatLng> selectedLocation` — 지도 좌표
- `RxBool isMapVisible` — 지도 표시 여부 (토글)

**주요 메서드:**
```dart
void setImages(List<String> urls)      // 이미지 추가
void removeImage(int index)            // 이미지 제거
void changeTitle(String value          // 제목 변경
void changePrice(String value)         // 가격 변경 (숫자만)
void toggleIsFree(bool value)          // 무료 나눔 토글
void toggleMapVisibility()             // 지도 표시/숨기기
void updateMapLocation(LatLng latLng)  // 지도 위치 업데이트
```

## 3. UI 구성 요소

**구조:**
1. **AppBar** — 닫기 버튼, "상품 등록" 제목, 완료 버튼 (Chapter 16에서 활성화)
2. **이미지 선택** — `image_picker`로 갤러리에서 선택 (최대 10장)
3. **카테고리 드롭다운** — 6개 카테고리
4. **제목 입력** — TextField
5. **가격 입력** — TextField (숫자만, 무료 나눔 시 비활성화)
6. **체크박스** — 무료 나눔, 가격 제안 받기
7. **상품 상태 드롭다운** — 4개 상태
8. **설명 입력** — TextField (maxLines: 5)
9. **거래 희망 장소** — 드롭다운 + Flutter Map (토글)

## 4. 이미지 선택 (image_picker)

**구현:**
```dart
Future<void> _pickImages(BuildContext context) async {
  final List<XFile> pickedFiles = await ImagePicker().pickMultiImage(
    maxWidth: 800,
    maxHeight: 800,
    imageQuality: 80,
  );
  
  if (pickedFiles.isNotEmpty) {
    final imageUrls = pickedFiles.map((file) => file.path).toList();
    controller.setImages(imageUrls);
  }
}
```

**특징:**
- `pickMultiImage()`: 여러 장 동시 선택
- 파일 경로를 String으로 저장
- 최대 10장 제한

## 5. Flutter Map 통합

**토글 버튼:**
```dart
GestureDetector(
  onTap: () => controller.toggleMapVisibility(),
  child: Container(
    // "지도 표시하기" / "지도 숨기기" 버튼
  ),
)
```

**지도 위젯:**
```dart
if (controller.isMapVisible.value)
  FlutterMap(
    options: MapOptions(
      initialCenter: controller.selectedLocation.value,
      initialZoom: 15,
      onTap: (tapPosition, latLng) {
        controller.updateMapLocation(latLng);
      },
    ),
    children: [
      TileLayer(
        urlTemplate: 'https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png',
        subdomains: const ['a', 'b', 'c'],
      ),
      MarkerLayer(
        markers: [
          Marker(
            point: controller.selectedLocation.value,
            child: Container(
              // 주황색 마커 아이콘
            ),
          ),
        ],
      ),
    ],
  )
```

**특징:**
- 토글 방식 (같은 페이지에서 표시/숨기기)
- 지도 탭 시 마커 이동
- OpenStreetMap 타일 사용

## 6. 체크박스 로직

**무료 나눔 체크 시:**
```dart
void toggleIsFree(bool value) {
  isFree(value);
  if (value) {
    priceText('0');         // 자동으로 0 설정
    isPriceSuggest(false);  // 가격 제안 자동 false
  }
}
```

**결과:**
- 가격 입력 필드 비활성화
- price = 0으로 설정

**가격 제안 받기:**
- 무료 나눔과 독립적으로 동작
- 가격 입력값에 영향 없음

## 7. 드롭다운 구현

**카테고리:**
```dart
DropdownButton<String>(
  value: controller.selectedCategory.value.isEmpty ? null : controller.selectedCategory.value,
  items: ['전자기기', '의류', '도서', '생활용품', '스포츠', '기타'].map((category) {
    return DropdownMenuItem(value: category, child: AppFont(category));
  }).toList(),
  onChanged: (value) {
    if (value != null) controller.changeCategory(value);
  },
)
```

**상품 상태:**
- 새 상품, 거의 새 상품, 사용감 있음, 많이 사용함

## 8. Firebase 미사용

GitHub 공식 코드와 달리 간소화:
- ❌ Firebase Storage 이미지 업로드 → 로컬 파일 경로 사용
- ❌ `photo_manager` 패키지 → `image_picker` 사용
- ❌ 별도 페이지 이동 → 같은 페이지에 통합
- ✅ 더 간단하고 학습하기 쉬운 구조

## 9. 구현 완료 체크리스트

✅ ProductWriteController 생성 (상태 관리)
✅ ProductWritePage UI 기본 구성
✅ image_picker 연동 (최대 10장)
✅ Flutter Map 토글 통합
✅ 드롭다운 구현 (카테고리, 상태, 위치)
✅ 체크박스 연동 (무료 나눔, 가격 제안)
✅ 다크 테마 적용
✅ main.dart 라우트 등록 (`/product/write`)

## 10. 핵심 학습점

- **GetX 상태 관리:** Rx 변수로 반응형 UI
- **image_picker:** `pickMultiImage()`로 여러 이미지 선택
- **Flutter Map:** OpenStreetMap 타일 + 마커
- **토글 UI:** 지도 표시/숨기기 버튼
- **체크박스 로직:**무료 나눔 시 가격 필드 자동 제어
- **드롭다운:** `DropdownButton<String>` 구현
