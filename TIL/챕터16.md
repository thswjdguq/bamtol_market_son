# TIL — Chapter 16 (유효성 검사 및 완료 버튼)

## 개요
상품 등록 폼의 실시간 유효성 검사 구현.
Debounce를 활용하여 성능 최적화하고, 완료 버튼을 동적으로 활성화/비활성화.

## 1. 유효성 검사 변수

**ProductWriteController:**
```dart
RxBool isPossibleSubmit = RxBool(false);  // 완료 버튼 활성화 여부

// 상수
static const int minTitleLength = 1;
static const int minPriceValue = 0;
```

## 2. onInit() — Debounce 설정

**GetX debounce 활용:**
```dart
@override
void onInit() {
  super.onInit();
  
  // 각 입력값 변경 시 100ms 후 유효성 검사
  debounce(title, (_) => _validateForm(), time: const Duration(milliseconds: 100));
  debounce(priceText, (_) => _validateForm(), time: const Duration(milliseconds: 100));
  debounce(isFree, (_) => _validateForm(), time: const Duration(milliseconds: 100));
  debounce(selectedCategory, (_) => _validateForm(), time: const Duration(milliseconds: 100));
  debounce(selectedCondition, (_) => _validateForm(), time: const Duration(milliseconds: 100));
}
```

**Debounce 목적:**
- 사용자가 입력할 때마다 즉시 검사하면 성능 저하
- 100ms 지연 후 검사하여 최적화
- 최종 입력값만 검사

**예시:**
```
사용자 입력: "맥" → "맥북" → "맥북 프로"
  ↓
debounce: 입력 멈추고 100ms 후 검증 실행 (1번만)
```

## 3 유효성 검사 로직

**_isFormValid() 메서드:**
```dart
bool _isFormValid() {
  // 1. 제목 필수 (공백 제거 후 1글자 이상)
  if (title.value.trim().isEmpty) {
    return false;
  }
  
  // 2. 무료 나눔이 아닐 경우 가격 필수
  if (!isFree.value) {
    if (priceText.value.isEmpty) {
      return false;
    }
    final price = int.tryParse(priceText.value);
    if (price == null || price < minPriceValue) {
      return false;
    }
  }
  
  // 3. 카테고리 필수
  if (selectedCategory.value.isEmpty) {
    return false;
  }
  
  // 4. 상품 상태 필수
  if (selectedCondition.value.isEmpty) {
    return false;
  }
  
  // 5. 위치는 기본값('아라동')이 있으므로 검사 불필요
  
  return true;
}
```

**검증 조건 요약:**

| 항목 | 필수 여부 | 조건 |
|------|----------|------|
| 이미지 | 선택 | 없어도 등록 가능 |
| 제목 | 필수 | 공백 제거 후 1글자 이상 |
| 카테고리 | 필수 | 선택 필요 |
| 가격 | 조건부 | 무료 나눔 아니면 필수 |
| 상품 상태 | 필수 | 선택 필요 |
| 설명 | 선택 | 없어도 등록 가능 |

## 4. 완료 버튼 UI

**AppBar 완료 버튼:**
```dart
Obx(() {
  final isActive = controller.isPossibleSubmit.value;
  return GestureDetector(
    onTap: isActive ? () => controller.submit() : null,
    child: IgnorePointer(
      ignoring: !isActive,
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: AppFont(
          '완료',
          color: isActive ? const Color(0xffED7738) : Colors.grey,
          fontWeight: FontWeight.bold,
          size: 16,
        ),
      ),
    ),
  );
})
```

**색상 변경:**
- 활성화 시: 주황색 (`#ED7738`)
- 비활성화 시: 회색 (`Colors.grey`)
- `IgnorePointer`로 클릭 차단

## 5. 무료 나눔 특별 처리

**무료 나눔 체크 시:**
```dart
void toggleIsFree(bool value) {
  isFree(value);
  if (value) {
    priceText('0');
    isPriceSuggest(false);
  }
  _validateForm();  // 유효성 재검사
}
```

**_isFormValid()에서:**
```dart
if (!isFree.value) {
  // 가격 검사 실행
} else {
  // 가격 검사 건너뜀
}
```

**결과:**
- 무료 나눔 체크 시 가격 입력 불필요
- 가격 필드가 비어있어도 유효성 검사 통과

## 6. 검증 메시지 (선택사항)

```dart
String getValidationMessage() {
  if (title.value.trim().isEmpty) {
    return '상품명을 입력해주세요.';
  }
  if (!isFree.value && priceText.value.isEmpty) {
    return '가격을 입력해주세요.';
  }
  if (selectedCategory.value.isEmpty) {
    return '카테고리를 선택해주세요.';
  }
  if (selectedCondition.value.isEmpty) {
    return '상품 상태를 선택해주세요.';
  }
  return '';
}
```

## 7. 동작 흐름

```
초기: isPossibleSubmit = false (완료 버튼 회색)
  ↓
사용자: 제목 입력 ("맥북")
  ↓
100ms 후 _validateForm() 실행
  - 제목 O, 카테고리 X → isPossibleSubmit = false
  ↓
사용자: 카테고리 선택
  ↓
100ms 후 _validateForm() 실행
  - 제목 O, 카테고리 O, 가격 X → isPossibleSubmit = false
  ↓
사용자: 가격 입력
  ↓
100ms 후 _validateForm() 실행
  - 제목 O, 카테고리 O, 가격 O, 상태 X → isPossibleSubmit = false
  ↓
사용자: 상품 상태 선택
  ↓
100ms 후 _validateForm() 실행
  - 모든 필수 항목 O → isPossibleSubmit = true
  - 완료 버튼 주황색 (활성화)
```

## 8. Debounce 성능 최적화

**Before (Debounce 없음):**
```
"맥북" 입력:
  'ㅁ' → _validateForm()
  '마' → _validateForm()
  '맥' → _validateForm()
  '맥ㅂ' → _validateForm()
  '맥부' → _validateForm()
  '맥북' → _validateForm()
총 6번 실행 ❌
```

**After (Debounce 100ms):**
```
"맥북" 입력:
  입력 완료 후 100ms 대기
  → _validateForm() 실행 (1번만) ✅
```

## 9. 구현 완료 체크리스트

✅ `_isFormValid()` 로직 구현
✅ `getValidationMessage()` 구현
✅ GetX `debounce()`로 실시간 검증
✅ 완료 버튼 색상 동적 변경
✅ 각 필드별 검증 트리거
✅ 무료 나눔 특별 처리
✅ `IgnorePointer`로 비활성화 시 클릭 차단

## 10. 핵심 학습점

- **Form Validation:** 여러 조건을 조합한 검증 로직
- **GetX debounce():** 성능 최적화 (100ms 지연)
- **Rx 변수 구독:** 상태 변화 자동 감지
- **조건부 활성화:** 체크박스에 따른 필드 제어
- **사용자 피드백:** 색상으로 입력 완료 여부 표시
- **IgnorePointer:** 비활성화 시 클릭 방지
